<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <link rel="icon" href="https://jscdn.com.cn/highcharts/images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* css 代码  */
    </style>
    <script type="text/javascript" src="./data_json.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.js"></script>
    <script src="http://cdn.hcharts.cn/highstock/10.0.0/highstock.js"></script>
    <script src="http://cdn.hcharts.cn/highstock/10.0.0/modules/exporting.js"></script>
    <script src="highcharts-zh_CN.js"></script>
</head>

<body>
    <div id="container" style="min-width:400px;height:400px"></div>
    <div id="container2" style="min-width:400px;height:400px"></div>
    <script>
    function isSameWeek(d1, d2) {
        if (d1 == "" || d2 == "") return false

        const ONE_DAY = 1000 * 60 * 60 * 24
        const difftime = Math.abs(d2 - d1)
        let bigDay = (d1 > d2 ? d1.getDay() : d2.getDay()) || 7
        let smallDay = (d1 < d2 ? d1.getDay() : d2.getDay()) || 7
        return !(difftime >= ONE_DAY * 7 || bigDay < smallDay || (bigDay === smallDay && difftime > ONE_DAY))
    }

    function dayToPeriod(dayIndexList, period) {

        let open, high, low, close, volume
        let preDayIndexDate = ""
        let periodIndexList = []
        let dayIndexListLastIndex = dayIndexList.length - 1

        dayIndexList.forEach((dayIndex, i, dayIndexList) => {

            currentDate = dayIndex.d
            currentOpen = parseFloat(dayIndex.o)
            currentHigh = parseFloat(dayIndex.h)
            currentLow = parseFloat(dayIndex.l)
            currentClose = parseFloat(dayIndex.c)
            currentVolume = parseFloat(dayIndex.v)

            let samePeriod
            if (period == "week")
                samePeriod = isSameWeek(new Date(preDayIndexDate), new Date(currentDate))
            if (period == "month")
                samePeriod = preDayIndexDate.substring(0, 7) == currentDate.substring(0, 7) ? true : false

            if (!samePeriod) {
                let prPeriodIndex = {
                    "d": preDayIndexDate,
                    "o": open,
                    "h": high,
                    "l": low,
                    "c": close,
                    "v": volume,
                }
                periodIndexList.push(prPeriodIndex)

                open = currentOpen
                high = currentHigh
                low = currentLow
                close = currentClose
                volume = currentVolume
                preDayIndexDate = currentDate
            }

            if (samePeriod) {
                high = currentHigh > high ? currentHigh : high
                low = currentLow < low ? currentLow : low
                close = currentClose
                volume = volume + currentVolume
                preDayIndexDate = currentDate
            }
            if (dayIndexListLastIndex == i) {
                let currentPeriodIndex = {
                    "d": currentDate,
                    "o": open,
                    "h": high,
                    "l": low,
                    "c": close,
                    "v": volume,
                }
                periodIndexList.push(currentPeriodIndex)
            }
        })

        return periodIndexList
    }

    cn原油month = dayToPeriod(cn原油day, "month")
    cn白糖month = dayToPeriod(cn白糖day, "month")

    
    cn原油month = cn原油month.map((element, index) => {
        return [new Date(element.d).getTime(), parseFloat(element.o) / 10, parseFloat(element.h) / 10, parseFloat(element.l) / 10, parseFloat(element.c) / 10]
    })
    cn白糖month = cn白糖month.map((element, index) => {
        return [new Date(element.d).getTime(), parseFloat(element.o) / 100, parseFloat(element.h) / 100, parseFloat(element.l) / 100, parseFloat(element.c) / 100]
    })

    cn原油month.shift()
    cn白糖month.shift()
  


    Highcharts.stockChart('container', {
        series: [{
                type: 'candlestick',
                name: 'us白糖',
                data: us白糖,
                color: 'green',
                lineColor: 'green',
                upColor: 'red',
                upLineColor: 'red',
                dataGrouping: {
                    enabled: false
                },
            },
            {
                type: 'candlestick',
                name: 'cn白糖month',
                data: cn白糖month,
                color: 'green',
                lineColor: 'green',
                upColor: 'red',
                upLineColor: 'red',
                dataGrouping: {
                    enabled: false
                },
            },
        ]
    });

    Highcharts.stockChart('container2', {
        series: [{
                type: 'candlestick',
                name: 'us原油',
                data: us原油,
                color: 'green',
                lineColor: 'green',
                upColor: 'red',
                upLineColor: 'red',
                dataGrouping: {
                    enabled: false
                },
            },
            {
                type: 'candlestick',
                name: 'cn原油month',
                data: cn原油month,
                color: 'green',
                lineColor: 'green',
                upColor: 'red',
                upLineColor: 'red',
                dataGrouping: {
                    enabled: false
                },
            }
        ]
    });
    </script>
</body>

</html>